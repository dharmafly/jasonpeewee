/*!
    Jason Peewee
    A cache-friendly JSONP super-assistant

    by Premasagar Rose <http://premasagar.com>,
       Dharmafly <http://dharmafly.com>

    Repo: <https://github.com/dharmafly/jasonpeewee>
    MIT license: http://opensource.org/licenses/mit-license.php

*/
(function(window){"use strict";var callbacksName="_jason",define=window["define"],document=window["document"],encodeURIComponent=window["encodeURIComponent"],objectKeys=window["Object"]["keys"],head=document.getElementsByTagName("head")[0],masterCallbacks={},privateCallbacks={},createUrlSignature;function sumCharCodes(str){var sum=0,i=str.length;for(;i;i--){sum+=str.charCodeAt(i-1)}return sum}createUrlSignature=function(){var trailingQuestionMark=/\?$/;return function(url){var sig="",components,domains,length,i;url=url.replace(trailingQuestionMark,"");components=url.split("?");domains=components[0].split(".");for(i=0,length=domains.length;i<length;i++){sig+="_"+sumCharCodes(domains[i])}for(i=0,length=components.length;i<length;i++){sig+="_"+sumCharCodes(components[i])}return sig}}();if(!objectKeys){objectKeys=function(obj){var keys=[],key;for(key in obj){if(obj.hasOwnProperty(key)){keys.push(key)}}return keys}}function sortedObjectKeys(obj){return objectKeys(obj).sort()}function encodeParameter(params,key){var value=params[key];return encodeURIComponent(key)+"="+encodeURIComponent(value)}function encodeAndSortQueryString(params){var keys=sortedObjectKeys(params),len=keys.length,i=0,queryString="";for(;i<len;i++){queryString+="&"+encodeParameter(params,keys[i])}return queryString.slice(1)}function createCollection(callbackName){var callbacks=privateCallbacks[callbackName]=[];masterCallbacks[callbackName]=function(data){while(callbacks.length){callbacks.shift()(data)}};return callbacks}function registerCallback(callbackName,callback){var callbacks=privateCallbacks[callbackName]||createCollection(callbackName);callbacks.push(callback);return callback}function generateScriptCallback(callbackName,errorCallback){return function(success,url){var callbacks=privateCallbacks[callbackName],callbackRemaining;if(callbacks){callbackRemaining=callbacks.shift();if(!callbacks.length){delete privateCallbacks[callbackName];delete masterCallbacks[callbackName]}}if(errorCallback&&callbackRemaining){errorCallback(url)}}}function getscript(url,callback,charset){var script=head.appendChild(document.createElement("script"));function cleanup(success){head.removeChild(script);script=script.onload=script.onreadystatechange=script.onerror=null;callback(success===true,url)}script.onload=script.onreadystatechange=function(){var state=this.readyState;if(script&&(!state||state==="complete"||state==="loaded")){cleanup(true)}};script.onerror=cleanup;script.type="text/javascript";script.charset=charset||"utf-8";script.src=url}function jasonpeewee(url,params,successCallback,settings){var callbackParameter="callback",charset,loadCallback,errorCallback,callbackName;if(typeof params==="function"){settings=successCallback;successCallback=params;params=null}if(settings){if(settings.callbackParameter){callbackParameter=settings.callbackParameter}errorCallback=settings["error"];charset=settings["charset"]}url+=url.indexOf("?")===-1?"?":"&";url+=params?encodeAndSortQueryString(params)+"&":"";callbackName=createUrlSignature(url);url+=callbackParameter+"="+jasonpeewee["path"]+"."+callbackName;registerCallback(callbackName,successCallback);loadCallback=generateScriptCallback(callbackName,errorCallback);getscript(url,loadCallback,charset);return url}window[callbacksName]=masterCallbacks;jasonpeewee["path"]=callbacksName;if(typeof define==="function"&&define["amd"]){define([],function(){return jasonpeewee})}else{window["jasonpeewee"]=jasonpeewee}})(this);